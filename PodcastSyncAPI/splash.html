<html>
<head>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="https://www.dropbox.com/static/api/dropbox-datastores-1.0-latest.js" type="text/javascript"></script>
    <script src="//cdn.jsdelivr.net/react/0.10.0/react-with-addons.min.js"></script>
    <script src="//cdn.jsdelivr.net/react/0.10.0/JSXTransformer.js"></script>

    <style>
        #file-url {
            width: 360px;
        }
    </style>

    <script type="text/jsx">
    /** @jsx React.DOM */
    var DownloadPodcastFile = React.createClass({
        render: function() {
            return (
                <div className="download-file">
                    <form className="download-form" onSubmit={this.handleSubmit}>
                        <input type="text" id="file-url"></input>
                        <button id="submit-file-download" type="submit" className="btn btn-primary">Send Podcast Episode To Dropbox!</button>
                    </form>
                </div>
            );
        },

        handleSubmit: function(e) {
            var creds = this.props.dbclient.credentials();

            $.ajax({
              url: "/podcast/download",
              dataType: 'json',
              type: 'POST',
              data: JSON.stringify({UID: creds.uid, AccessToken: creds.token, PodcastURL: $("#file-url").val()}),
              success: function(data) {
                  alert("success! " + data)
                // this.setState({data: data});
              }.bind(this)
            });
            e.preventDefault();
            return false;
        }
    });

    function startApp(dbclient) {
      React.renderComponent(
        <DownloadPodcastFile dbclient={dbclient}/>,
        document.getElementById('podcast-ui')
      );
    }

    $(function(){
        var client = new Dropbox.Client({key: "5rwi62sv3nl0p90"});

        // Try to finish OAuth authorization.
        client.authenticate({interactive: false}, function (error) {
            if (error) {
                alert('Authentication error: ' + error);
            }
        });

        if (client.isAuthenticated()) {
            // Client is authenticated. Display UI.
            console.log(client.credentials());
            $("#start").hide();
            startApp(client);
        }

        $('#start').click(function(e){
            client.authenticate();
        });
    });

    </script>

    <title>{{.}}</title>
</head>
<body>
    <h1>podcastsync</h1>
    <h1><small>Subscribe to Podcasts and have them automatically sent to your Dropbox!</small></h1>
    <button id="start" type="button" class="btn btn-primary">Get Started!</button>
    <div id="podcast-ui"></div>

</body>
</html>
